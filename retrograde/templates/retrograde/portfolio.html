{% extends "retrograde/layout.html" %}
{% load tz %}
{% block body %}
{% load static %}
<b>My Portfolios > {{ portfolio.name }}</b>

<div id="big-portfolio-card" class="card">
  <div class="card-body" style="display: flex; padding: 20px 10px 0px 10px;">
    <div style="flex: 3;">
      <h2 class="card-title">{{ portfolio.name }}</h2>
      <h5 class="card-subtitle mb-2 text-body-secondary"><small>Simulation Date: {{ portfolio.date|date:"l, j F Y" }}</small> </h5>
    </div>
    <div style="flex: 1; text-align: right;">
      
      <h2 style="margin-bottom: 0px;" ><small style="font-size: 16px; margin-right: 10px;">USD </small>{{ portfolio.value }}</h2>
      {% if portfolio.change_status == "POSITIVE" %}
      <h5><span class="badge text-bg-success">{{ portfolio.change }}</span></h5>    
      {% elif portfolio.change_status == "ZERO" %}
      <h5><span class="badge text-bg-light">{{ portfolio.change }}</span></h5>    
      {% elif portfolio.change_status == "NEGATIVE" %}
      <h5><span class="badge text-bg-danger">{{ portfolio.change }}</span></h5>    
      {% endif %}
    </div>
  </div>
  <div style="display: flex;">
    <hr style="border: none; border-top: 2px solid #CCC; margin: 20px 0; width: 100%;">
  </div>
  <!-- Place the canvas element below the flex container -->
  {% comment %}   <div style="display: flex; justify-content: center; padding: 0px 30px 10px 30px;">
    <ul class="nav nav-pills" style="font-size: smaller; font-weight: bold;">
      <button id="oneD" type="button" class="btn btn-primary" style="margin: 5px; font-size: small; font-weight: bold;">All</button>
      <button id="oneW" type="button" class="btn btn-light" style="margin: 5px; font-size: small; font-weight: bold;">Day</button>
      <button id="oneW" type="button" class="btn btn-light" style="margin: 5px; font-size: small; font-weight: bold;">Week</button>
      <button id="oneM" type="button" class="btn btn-light" style="margin: 5px; font-size: small; font-weight: bold;">Month</button>
      <button id="threeM" type="button" class="btn btn-light" style="margin: 5px; font-size: small; font-weight: bold;">Year</button>
    </ul>
  </div> {% endcomment %}
  <div>
    <h4 style="margin-bottom: 0px;">Portfolio Value</h4>
    <small>How your portfolio has performed since inception.</small>
    <div style="height: 200px; margin-top: 10px;">
      <canvas id='assetValue' style="width: 100%;"></canvas>
    </div>
  </div>            
  
  <div>
    
    <div class="container" style="margin: 20px 0px 40px 0px;">
      <div class="row">
        <div class="col-md-8">
          <div class="card" style="height: 19rem; border: none; padding: 10px; background-color: rgba(13, 110, 253, 0.8); color: white;">
            <div class="card-body" style="height:100%">
              <h4 class="card-title">Portfolio Performance</h4>
              <hr style="margin: 6px 0px; line-height: 4px;">
              
              {% comment %}              <small> Total Return: {{ portfolio.financial_performance.total_return }} <br>
                Sharpe Ratio: {{ portfolio.financial_performance.sharpe_ratio }}
                <br> Volatility, Beta: {{ portfolio.financial_performance_beta }}
                <br> Alpha: {{ portfolio.financial_performance_alpha }}
                <br> Treynor Ratio: {{ portfolio.financial_performance_treynor_ratio }}
                <br> Volatility: {{ portfolio.financial_performance_volatility }}
                <br> Information Ratio, Drawdown Analysis. Yield and Income Metrics. Duration and Convexity </small>
                {% endcomment %}                
                <div style="text-align: right;">
                  <h4 class="card-title">Profit to Date: $1,432.34</h4>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card" style="color: white; height: 19rem; border: none; padding: 10px; background-color: rgba(150, 115, 240, 1);">
              
              <div class="card-body">
                <h4 class="card-title" style="">Feedback</h4>
                <hr style="margin: 0px 0px; height: 4px;">
                <figure style="margin: 0px;" >
                  <blockquote class="blockquote" style="margin-bottom:5px;">
                    <p style="font-size:9px; margin-bottom: 10px; font-style: italic">Generated using ChatGPT-4</p>
                    <div id="chat-container" style="font-size: 13px; margin-bottom: 5px;">
                    </div>
                    <p>
                      {% comment %} 25 words {% endcomment %}
                    </p>
                  </blockquote>
                </figure>
              </div>
            </div>
          </div>
          
        </div>
        <div class="d-flex justify-content-end">
          <button id="tick_one_day_button" type="button" class="btn btn-primary btn-lg" onclick="tickOneDay()">
            Tick One Day
          </button>
        </div>
      </div>
      
      
      <h4 style="margin-bottom: 0px;">Assets Held</h4>
      <small>All the assets that you hold and their market data for the past 3 months.</small>
      <div class="btn-group float-end" role="group" aria-label="Basic outlined example">
        <button id="showAllButton" class="btn btn-primary" {% comment %} onclick="dropAssets()"  {% endcomment %}style="font-size: 12px;">Show All</button>
        <button id="collapseAllButton" class="btn btn-primary" {% comment %} onclick="collapseAssets()" {% endcomment %} style="font-size: 12px;">Collapse All</button>
      </div>
      
      <table class="table" style="margin-top: 30px;">
        <thead>
          <tr>
            <th scope="col">Asset</th>
            <th scope="col" style="text-align: center;">Price</th>
            <th scope="col" style="text-align: right;">Allocation (USD)</th>
          </tr>
        </thead>
      </table>
      
      <div class="accordion accordion-flush" id="accordionPanelsStayOpenExample">
        {% for asset in portfolio.asset_data %}
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" style="backgroundColor: white;" type="button" data-bs-toggle="collapse" data-bs-target="#{{ 'panelsStayOpen-collapse'|add:asset.index }}" aria-expanded="false" aria-controls="{{ 'panelsStayOpen-collapse'|add:asset.index }}">
              <div class="asset-row">
                <div class="asset-info">
                  <b>{{ asset.ticker }}</b><br>
                  <small>{{ asset.long_name }}</small>
                </div>
                <div class="asset-chart" style="height: 50px; width: 100px;">
                  <canvas id="{{ 'asset_chart_'|add:asset.index }}"></canvas>
                </div>
                <div class="asset-details" style=" display: flex; align-items: center;">
                  <div style="text-align: right; height:40px; width: 100px">
                    <h6 style="margin-bottom: 0px;">
                      {% if asset.currency != "USD"  %}<small style="font-size: 9px; margin-right:2px;"> {{ asset.currency }}</small>
                      {% endif %}
                      {{ asset.current_price }}</h6>
                      {% if asset.current_price_change_status == "POSITIVE" %}
                      <h6><span class="badge text-bg-success">{{ asset.current_price_change }}</span></h6>
                      {% elif asset.current_price_change_status == "ZERO" %}
                      <h6><span class="badge text-bg-light">{{ asset.current_price_change }}</span></h6>
                      {% elif asset.current_price_change_status == "NEGATIVE" %}
                      <h6><span class="badge text-bg-danger">{{ asset.current_price_change }}</span></h6>
                      {% endif %}
                    </div>
                    
                    <div style="width: 70px; text-align: center; margin-left: 30px;">
                      <h6 style="margin: 0px">{{ asset.current_num_units }}</h6>
                    </div>
                    <div style="text-align: right; width: 80px;">
                      <b>{{ asset.current_value }}</b><br>
                      <small>{{ asset.current_value_percent }}</small>
                    </div>
                  </div>
                </div>
              </button>
            </h2>
            
            <div id="{{ 'panelsStayOpen-collapse'|add:asset.index }}" class="accordion-collapse collapse">
              <div class="accordion-body">
                
                {% if asset.ticker != "Cash Balance"  %}
                <div class="info-container">
                  <p class="info-pair">Currency: <strong>{{ asset.currency }}</strong></p>
                  <p class="info-pair">Country: <strong>{{ asset.country }}</strong> </p>
                  <p class="info-pair">Quote type: <strong>{{ asset.quote_type }}</strong></p>
                  <p class="info-pair">Exchange: <strong>{{ asset.exchange }}</strong></p>
                </div>
                <br>
                <small><b>Price Data of {{ asset.ticker }} for the last 3 months</b></small>
                <div style="height: 200px; margin-top: 10px;">
                  <canvas id="{{ 'price_chart_'|add:asset.index }}" style="height: 100px; width: 100%;"></canvas>
                </div>
                <br>
                <small><b>Candlestick Data of {{ asset.ticker }} for the last 3 months</b></small>
                <canvas id="{{ 'asset_chart_two_'|add:asset.index }}" style="height: 100px;"></canvas>
                <div id="{{ 'asset_chart_spinner_'|add:asset.index }}" class="d-flex justify-content-center align-items-center d-none" style="width: 898px; height: 400px;">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden"></span>
                  </div>
                </div>
                
                <h6>Summary</h6>
                <p style="font-size: 11px;">{{ asset.long_business_summary }}</p>
                <div class="d-flex justify-content-center align-items-center">
                  <div id="trade-order" style="width: 50%; margin-top: 20px;">
                    <div style="display: flex; justify-content: center; align-items: center;">
                      <strong>
                        <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
                          <input type="checkbox" class="btn-check" id="{{ 'buy-order-button_'|add:asset.index }}" data-index="{{ asset.index }}" autocomplete="off" data-bs-toggle="collapse" data-bs-target="#{{ 'collapseBuy_'|add:asset.index }}" aria-expanded="false" aria-controls="{{ 'collapseBuy_'|add:asset.index }}" style="width: 90px; margin: 0px 5px;">
                          <label class="btn btn-outline-primary btn-sm" for="{{ 'buy-order-button_'|add:asset.index }}">Buy Order</label>
                          <input type="checkbox" class="btn-check" id="{{ 'sell-order-button_'|add:asset.index }}" data-index="{{ asset.index }}" autocomplete="off" data-bs-toggle="collapse" data-bs-target="#{{ 'collapseSell_'|add:asset.index }}" aria-expanded="false" aria-controls="{{ 'collapseSell_'|add:asset.index }}" style="width: 90px; margin: 0px 5px;">
                          <label class="btn btn-outline-primary btn-sm" for="{{ 'sell-order-button_'|add:asset.index }}">Sell Order</label>
                        </div>
                      </strong>
                    </div>
                    
                    <br>
                    <div id="{{ 'collapseOrder_'|add:asset.index }}" style="display: block; margin: 0px 0px;">
                      <div class="order collapse show" id="{{ 'collapseBuy_'|add:asset.index }}" data-index="{{ asset.index }}" style="border-radius: 25px; border-width: 1px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                        <div class="card-header" style="border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px 20px 10px 20px; border-bottom-width: 0px !important;">
                          <h5><b>Buy Order</b></h5>
                        </div>
                        <form action="{% url 'buy_asset' portfolio.id %}" method="POST" class="card-body" style="padding: 10px 25px 25px 25px; font-size: 14px; width: 100% !important;">
                          {% csrf_token %}
                          
                          <div class="mb-3 row" style="margin-bottom: 0px !important;">
                            <label for="staticEmail" class="col-sm-6 col-form-label">Asset</label>
                            <p class="col-sm-1 col-form-label">:</p>
                            
                            <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                              <b>{{ asset.ticker }}</b>
                              
                              <input name="ticker" type="text" readonly hidden class="form-control-plaintext" id="staticEmail" value="{{ asset.ticker }}">
                            </div>
                          </div>
                          <div class="mb-3 row" style="margin-bottom: 6px !important;">
                            <label for="inputPassword" class="col-sm-6 col-form-label">Current Price per unit</label>
                            <p class="col-sm-1 col-form-label">:</p>
                            {% if asset.currency == "USD"  %}
                            <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                              <b>USD {{ asset.current_price }}</b>
                            </div>
                            {% else %}
                            <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                              <b>{{ asset.currency }} {{ asset.current_price }}</b>
                            </div>
                            <label for="inputPassword" class="col-sm-7 col-form-label"></label>
                            <div id="{{ 'buy-current-price-usd_'|add:asset.index }}" data-value="{{ asset.current_price_usd }}" class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                            USD {{ asset.current_price_usd|floatformat:3 }}
                            </div>
                            {% endif %}
                            
                          </div>
                          <div class="mb-3 row" style="margin-bottom: 6px !important;">
                            <label for="inputPassword" class="col-sm-6 col-form-label">Number of units</label>
                            <p class="col-sm-1 col-form-label">:</p>
                            <div class="col-sm-5">
                              <b>
                                <input name="units" type="text" class="form-control" id="{{ 'buy-num-units_'|add:asset.index }}" data-index="{{ asset.index }}" data-price="{{ asset.current_price }}" data-current_units="{{ asset.current_num_units }}" style="text-align: right; font-size: 14px;">
                                <div id="{{ 'buy-num-units_'|add:asset.index|add:'InvalidFeedback' }}" class="invalid-feedback">
                                </div>
                                <div id="{{ 'buy-num-units_'|add:asset.index|add:'ValidFeedback' }}" class="valid-feedback">
                                  Looks good!
                                </div>
                              </b>
                            </div>
                          </div>
                          <hr>
                          <div class="mb-3 row" style="margin-bottom: 0px !important;">
                            <label for="staticEmail" class="col-sm-6 col-form-label">Current Cash Balance</label>
                            <p class="col-sm-1 col-form-label">:</p>
                            <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                              USD {{ portfolio.cash_balance }}
                            </div>
                          </div>
                          <div class="mb-3 row" style="margin-bottom: 12px !important;">
                            <label for="inputPassword" class="col-sm-6 col-form-label">Order value</label>
                            <p class="col-sm-1 col-form-label">:</p>
                            <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                              <b id="{{ 'buy-order-value_'|add:asset.index }}">-</b>
                            </div>
                            
                          </div>
                          <div class="d-flex justify-content-end">
                            <button id="{{ 'placeBuyOrder_'|add:asset.index }}" type="submit" class="btn btn-primary btn-sm" style="width: 100px;">Place Order</button>
                          </div> 
                          
                        </form>
                      </div>
                      
                      <div class="order collapse show" id="{{ 'collapseSell_'|add:asset.index }}" data-index="{{ asset.index }}" style="border-radius: 25px; border-width: 1px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                        <div class="card-header" style="border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px 20px 10px 20px; border-bottom-width: 0px !important;">
                          <h5><b>Sell Order</b></h5>
                        </div>
                        <form action="{% url 'sell_asset' portfolio.id %}" method="POST"  class="card-body" style="padding: 10px 25px 25px 25px; font-size: 14px; width: 100% !important;">
                          {% csrf_token %}
                          
                          <div class="mb-3 row" style="margin-bottom: 0px !important;">
                            <label for="staticEmail" class="col-sm-6 col-form-label">Asset</label>
                            <p class="col-sm-1 col-form-label">:</p>
                            
                            <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                              <b>{{ asset.ticker }}</b>
                              
                              <input name="ticker" type="text" readonly hidden class="form-control-plaintext" id="staticEmail" value="{{ asset.ticker }}">
                            </div>
                          </div>
                          <div class="mb-3 row" style="margin-bottom: 6px !important;">
                            <label for="inputPassword" class="col-sm-6 col-form-label">Current Price per unit</label>
                            <p class="col-sm-1 col-form-label">:</p>
                            
                            {% if asset.currency == "USD"  %}
                            <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                              <b>USD {{ asset.current_price }}</b>
                            </div>
                            {% else %}
                            <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                              <b>{{ asset.currency }} {{ asset.current_price }}</b>
                            </div>
                            <label for="inputPassword" class="col-sm-7 col-form-label"></label>
                            <div id="{{ 'sell-current-price-usd_'|add:asset.index }}" data-value="{{ asset.current_price_usd }}" class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                            USD {{ asset.current_price_usd|floatformat:3 }}
                            </div>
                            {% endif %}
                          </div>
                          <div class="mb-3 row" style="margin-bottom: 6px !important;">
                            <label for="inputPassword" class="col-sm-6 col-form-label">Number of units</label>
                            <p class="col-sm-1 col-form-label">:</p>
                            <div class="col-sm-5">
                              <b>
                                <input name="units" type="text" class="form-control" id="{{ 'sell-num-units_'|add:asset.index }}" data-index="{{ asset.index }}" data-price="{{ asset.current_price }}"  data-current_units="{{ asset.current_num_units }}" style="text-align: right; font-size: 14px;">
                                <div id="{{ 'sell-num-units_'|add:asset.index|add:'InvalidFeedback' }}" class="invalid-feedback">
                                </div>
                                <div id="{{ 'sell-num-units_'|add:asset.index|add:'ValidFeedback' }}" class="valid-feedback">
                                  Looks good!
                                </div>
                              </b>
                            </div>
                          </div>
                          <hr>
                          <div class="mb-3 row" style="margin-bottom: 0px !important;">
                            <label for="staticEmail" class="col-sm-6 col-form-label">Current Cash Balance</label>
                            <p class="col-sm-1 col-form-label">:</p>
                            <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                              USD {{ portfolio.cash_balance }}
                            </div>
                          </div>
                          <div class="mb-3 row" style="margin-bottom: 12px !important;">
                            <label for="inputPassword" class="col-sm-6 col-form-label">Order value</label>
                            <p class="col-sm-1 col-form-label">:</p>
                            <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                              <b id="{{ 'sell-order-value_'|add:asset.index }}">-</b>
                            </div>
                            
                          </div>
                          <div class="d-flex justify-content-end">
                            <button id="{{ 'placeSellOrder_'|add:asset.index }}" type="submit" class="btn btn-primary btn-sm" style="width: 100px;">Place Order</button>
                          </div> 
                          
                        </form>                        
                      </div> 
                    </div>                 
                  </div>    
                </div>
                {% else %}
                Content for cash balance
                {% endif %}
              </div>
            </div>
          </div>
          
          {% endfor %}
          
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" style="backgroundColor: white;" type="button" data-bs-toggle="collapse"  data-bs-target="#panelsStayOpen-collapse-new-asset" aria-expanded="false" aria-controls="panelsStayOpen-collapse-new-asset">
                <div class="asset-row" style="height: 50px;">
                  <div class="asset-info" style="text-align: center; display: flex; align-items: center; justify-content: center; text-align: center;">
                    <b> Add New Asset </b>
                    
                  </div>
                </button>
              </h2>
              
              <div id="panelsStayOpen-collapse-new-asset" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <div class="input-group d-flex mx-auto" style="width: 60%;">
                    <input id="search_ticker" type="search" class="form-control rounded" placeholder="Search" aria-label="Search" aria-describedby="search-addon" style="border-bottom-right-radius: 0px !important; border-top-right-radius: 0px !important;"/>
                    <button id="search_trigger" type="button" class="btn btn-outline-primary" data-mdb-ripple-init>search</button>
                  </div>
                  <br>
                  <br>
                  <div id="search_asset_data" style="display: none;">
                    <div class="asset-row mx-auto" style="width: 100%;">
                      <div class="asset-info">
                        <b id="search_asset_ticker"></b><br>
                        <small id="search_asset_long_name"></small>
                      </div>
                      <div class="asset-chart" style="height: 50px; width: 100px;">
                        <canvas id="search_asset_small_chart"></canvas>
                      </div>
                      <div class="asset-details" style="display: flex; align-items: center;">
                        <div style="text-align: right; height: 40px; width: 100%; margin-right: 0px;">
                          <h6 id="search_asset_price" style="margin-bottom: 0px;"></h6>
                          <h6><span id="search_asset_price_change" class="badge text-bg-success"></span></h6>
                        </div>
                        <!-- {% comment %}
                          <div style="text-align: right; width: 80px;">
                            <b>{{ asset.current_value }}</b>
                          </div> {% endcomment %} -->
                          
                        </div>
                      </div>
                      <br>
                      <div class="info-container">
                        <p class="info-pair">Currency: <strong id="search_asset_currency"></strong></p>
                        <p class="info-pair">Country: <strong id="search_asset_country"></strong> </p>
                        <p class="info-pair">Quote type: <strong id="search_asset_quote_type"></strong></p>
                        <p class="info-pair">Exchange: <strong id="search_asset_exchange"></strong></p>
                      </div>
                      <br>
                      <small><b>Price Data for the last 3 months</b></small>
                      <div style="height: 200px; margin-top: 10px;">
                        <canvas id="search_asset_price_chart" style="height: 100px; width: 100%;"></canvas>
                      </div>
                      <br>
                      <small><b>Candlestick Data for the last 3 months</b></small>
                      <canvas id="asset_chart_two_search_asset" style="height: 100px;"></canvas>
                      <div id="asset_chart_spinner_search_asset" class="d-flex justify-content-center align-items-center d-none" style="width: 898px; height: 400px;">
                        <div class="spinner-border" role="status">
                          <span class="visually-hidden"></span>
                        </div>
                      </div>
                      
                      <h6>Summary</h6>
                      <p id="search_asset_summary" style="font-size: 11px;"></p>          
                      <div class="d-flex justify-content-center align-items-center">
                        <div id="trade-order" style="width: 50%; margin-top: 20px;">
                          <div style="display: flex; justify-content: center; align-items: center;">
                            <strong>
                              <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
                                <input type="checkbox" class="btn-check" id='buy-order-button_search_asset' data-index="search_asset" autocomplete="off" data-bs-toggle="collapse" data-bs-target="#collapseBuy_search_asset" aria-expanded="false" aria-controls="collapseBuy_search_asset" style="width: 90px; margin: 0px 5px;">
                                <label class="btn btn-outline-primary btn-sm" for='buy-order-button_search_asset'>Buy Order</label>
                              </div>
                            </strong>
                          </div>
                          
                          <br>
                          <div id="collapseOrder_search_asset" style="display: block; margin: 0px 0px;">
                            <div class="order collapse" id="collapseBuy_search_asset" data-index="search_asset" style="border-radius: 25px; border-width: 1px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                              <div class="card-header" style="border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px 20px 10px 20px; border-bottom-width: 0px !important;">
                                <h5><b>Buy Order</b></h5>
                              </div>
                              <form action="{% url 'buy_asset' portfolio.id %}" method="POST" class="card-body" style="padding: 10px 25px 25px 25px; font-size: 14px; width: 100% !important;">
                                {% csrf_token %}
                                
                                <div class="mb-3 row" style="margin-bottom: 0px !important;">
                                  <label for="staticEmail" class="col-sm-6 col-form-label">Asset</label>
                                  <p class="col-sm-1 col-form-label">:</p>
                                  
                                  <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                                    <b id="buy_search_asset_display"></b>
                                    
                                    <input name="ticker" type="text" readonly hidden class="form-control-plaintext" id="buy_search_asset_input" value="">
                                  </div>
                                </div>
                                <div class="mb-3 row" style="margin-bottom: 6px !important;">
                                  <label for="inputPassword" class="col-sm-6 col-form-label">Current Price per unit</label>
                                  <p class="col-sm-1 col-form-label">:</p>
                                  
                                  <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                                    <b id="buy_search_asset_price"></b>
                                  </div>
                                  <div id="buy-rate-container_search_asset" style="display: none; padding: 0px !important;">
                                    <label for="inputPassword" class="col-sm-7 col-form-label"></label>
                                    <div id='buy-current-price-usd_search_asset' class="col-sm-5" style="padding: 6px 12px; text-align: right;"></div>
                                  </div>
                                  
                                </div>

                                <div class="mb-3 row" style="margin-bottom: 6px !important;">
                                  <label for="inputPassword" class="col-sm-6 col-form-label">Number of units</label>
                                  <p class="col-sm-1 col-form-label">:</p>
                                  <div class="col-sm-5">
                                    <b>
                                      <input required name="units" type="text" class="form-control" id='buy-num-units_search_asset' data-index="search_asset" data-price=""  data-current_units="" style="text-align: right; font-size: 14px;">
                                      <div id='buy-num-units_search_assetInvalidFeedback' class="invalid-feedback">
                                      </div>
                                      <div id='buy-num-units_search_assetValidFeedback' class="valid-feedback">
                                        Looks good!
                                      </div>
                                    </b>
                                  </div>
                                </div>
                                <hr>
                                <div class="mb-3 row" style="margin-bottom: 0px !important;">
                                  <label for="staticEmail" class="col-sm-6 col-form-label">Current Cash Balance</label>
                                  <p class="col-sm-1 col-form-label">:</p>
                                  <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                                    USD {{ portfolio.cash_balance }}
                                  </div>
                                </div>
                                <div class="mb-3 row" style="margin-bottom: 12px !important;">
                                  <label for="inputPassword" class="col-sm-6 col-form-label">Order value</label>
                                  <p class="col-sm-1 col-form-label">:</p>
                                  <div class="col-sm-5" style="padding: 6px 12px; text-align: right;">
                                    <b id='buy-order-value_search_asset'>-</b>
                                  </div>
                                  
                                </div>
                                <div class="d-flex justify-content-end">
                                  <button id='placeBuyOrder_search_asset' type="submit" class="btn btn-primary btn-sm" style="width: 100px;">Place Order</button>
                                </div> 
                                
                              </form>
                            </div>
                            
                          </div>                 
                        </div>    
                      </div>
                    </div>
                  </div>
                  <div id="search_asset_spinner" class="d-flex justify-content-center align-items-center d-none" style="width: 898px; height: 400px;">
                    <div class="spinner-border" role="status">
                      <span class="visually-hidden"></span>
                    </div>
                  </div>
                </div>
                
              </div>
              
              <div class="accordion-item" style="height: 90px; display: flex; align-items: center; justify-content: center; text-align: center; border-bottom-width: 1px;">
              </div>      
              
            </div>
          </div>
          
          
          
          
          {% if portfolio.news.items != "0" %}
          <div style="margin-bottom: 30px;">
            <h4 style="margin-bottom: 0px;">Today's News</h4>
            <small>Read today's news to improve your investing strategy.</small>
            
            <div id="carouselExampleAutoplaying" class="carousel slide" data-bs-ride="carousel" data-interval="1000" style="margin: 20px 0px 40px 0px">
              <div class="carousel-inner">
                {% for article in portfolio.news.feed %}
                {% if forloop.first %}
                <div class="card mb-3 carousel-item active" id="{{ 'article_'|add:forloop.counter0 }}" onclick="openInNewTab('{{ article.url }}')">
                  {% else %}
                  <div class="card mb-3 carousel-item" id="{{ 'article_'|add:forloop.counter0 }}" onclick="openInNewTab('{{ article.url }}')">
                    {% endif %}
                    <div class="row g-0">
                      <div class="image_container">
                        <img src="{{ article.banner_image }}" class="img-fluid rounded-start d-block" alt="Descriptive text about your primary image"
                        onerror="this.onerror=null; this.src='{% static 'retrograde/news.png' %}';">
                      </div>
                      <div class="col-md-6 news-content">
                        <div class="card-body" style="padding-top: 10px; padding-bottom: 0px;">
                          <div style="height: 165px;">
                            <h6 style="margin-bottom: 0px;">{{ article.source }}</h6>
                            <h5 class="card-title" style="font-weight: heavy; margin-bottom: 2px;">{{ article.title }}</h5>
                            {% comment %} <hr style="margin-top: 0px; margin-bottom: 5px; border-top-width: 2px; border-color: black !important;"> {% endcomment %}
                            <p class="card-text" style="font-size: 12px;">{{ article.summary }}</p>
                          </div>
                          <p class="card-text"><small class="text-body-secondary" style="font-size: 12px;">{{ article.time_published }}</small></p>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleAutoplaying" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleAutoplaying" data-bs-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Next</span>
                </button>
              </div>
            </div>
            {% endif %}
            
            <div style="margin-bottom: 30px;">
              <h4 style="margin-bottom: 0px;">Asset Allocation</h4>
              <small>How the mix of assets held under the portfolio has changed with time.</small>
              <canvas id='allocation_chart' style="width: 100%; height: 150px; margin-top: 10px;"></canvas>
            </div>

            <div style="margin-top: 10px; margin-bottom: 20px;">
              {% if portfolio.archived %}
              <a href="javascript:void(0);" style="color: black; font-size: 14px; display: inline-block !important; margin-right: 10px;" onclick="closePortfolio()">
                × Close Portfolio
              </a>
              <a href="javascript:void(0);" style="color: black; font-size: 14px; display: inline-block !important; margin-right: 10px;" onclick="unarchivePortfolio()">
                + Unarchive Portfolio
              </a>
              {% else %}
              <a href="javascript:void(0);" style="color: black; font-size: 14px; display: inline-block !important; margin-right: 10px;" onclick="archivePortfolio()">
                - Archive Portfolio
              </a>
              {% endif %}
            </div>
          </div>
          <script src="{% static 'retrograde/portfolio.js' %}" type="text/javascript"></script>
          
          <script>
            const RED_BORDER = 'rgba(255, 75, 66, 1)'
            const RED_BACKGROUND = 'rgba(255, 75, 66, 0.15)'
            
            const GREEN_BORDER = 'rgba(100, 220, 150, 1)'
            const GREEN_BACKGROUND = 'rgba(100, 220, 150, 0.15)'
            
            const TOOLTIP_COLOR = 'rgba(13, 110, 253, 1)'
            
            document.addEventListener('DOMContentLoaded', function () {
              
              // Sample data
              console.log("{{ user_timezone }}")
              var price_data = {{ portfolio.price_data|safe }};
              
              // Create portfolio value chart
              var ctx = document.getElementById('assetValue').getContext('2d');
              ctx.canvas.width = '898px';
              ctx.canvas.height = '150px';
              //console.log(dateLabels)
              
              portfolioChangeStatus = "{{ portfolio.change_status }}";
              if (portfolioChangeStatus === "NEGATIVE") {
                borderColor = RED_BORDER;
                backgroundColor = RED_BACKGROUND;
              } else {
                borderColor = GREEN_BORDER;
                backgroundColor = GREEN_BACKGROUND;
              }
              
              var myLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: price_data["date"],
                  datasets: [{
                    data: price_data["value"],
                    fill: true,
                    backgroundColor: backgroundColor,
                    borderColor: borderColor,
                    borderWidth: 3,
                    pointRadius: 10,
                    pointBorderColor: 'rgba(100, 220, 150, 0)',
                    pointBackgroundColor: 'rgba(100, 220, 150, 0)',
                    pointHoverRadius: 10,
                    pointHoverBackgroundColor: borderColor,
                    pointHoverBorderColor: 'rgba(255, 255, 255, 1)',
                    pointHoverBorderWidth: 3,
                  }]
                },
                options: {
                  scales: {
                    x: {
                      type: 'time',
                      time: {
                        unit: 'day',
                        tooltipFormat: 'DD'
                      },
                      ticks: {
                        maxTicksLimit: 4, // Set the maximum number of x-axis labels
                        maxRotation: 0,   // Set the maximum label rotation angle
                        minRotation: 0,
                        align: 'start',
                        font: {
                          size: 14,
                          weight: 'bold'
                        },  
                      },
                      grid: {
                        tickColor: 'rgba(255, 255, 255, 1)'
                      }
                    },
                    y: {
                      beginAtZero: false,
                      position: 'right',
                      ticks: {
                        // You can add additional y-axis tick options here if needed
                        maxTicksLimit: 4, // Set the maximum number of x-axis labels
                        includeBounds: true,
                        crossAlign: 'far',
                        font: {
                          size: 14,
                          weight: 'bold'
                        },  
                      },
                      grid: {
                        tickColor: 'rgba(255, 255, 255, 1)'
                      }
                    }
                  },
                  animation: false,
                  tooltips: {
                    intersect: false,
                  },
                  hover: {
                    mode: 'index',
                    intersect: false
                  },
                  plugins: {
                    legend: {
                      display: false,
                    },
                    tooltip: {
                      mode: 'index',
                      displayColors: false,
                      backgroundColor: 'rgba(255, 255, 255, 1)',
                      titleColor: 'rgba(0, 0, 0, 1)',
                      bodyColor: 'rgba(0, 0, 0, 1)',
                      padding: 12,
                      cornerRadius: 12,
                      caretPadding: 12,
                      caretSize: 8,
                      bodyAlign: 'right'
                    }
                  },
                }
              });
              
              var ctx = document.getElementById('allocation_chart').getContext('2d');
              ctx.canvas.width = '898px';
              ctx.canvas.height = '100px';
              //console.log(dateLabels)
              
              // Create empty asset mix chart
              var myLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: price_data["date"],
                  datasets: []
                },
                options: {
                  scales: {
                    x: {
                      type: 'time',
                      time: {
                        unit: 'day',
                        tooltipFormat: 'DD'
                      },
                      ticks: {
                        maxTicksLimit: 4, // Set the maximum number of x-axis labels
                        maxRotation: 0,   // Set the maximum label rotation angle
                        minRotation: 0,
                        align: 'start',
                        font: {
                          size: 14,
                          weight: 'bold'
                        },  
                      },
                      grid: {
                        tickColor: 'rgba(255, 255, 255, 1)'
                      },
                    },
                    y: {
                      beginAtZero: true,
                      position: 'right',
                      ticks: {
                        // You can add additional y-axis tick options here if needed
                        maxTicksLimit: 3, // Set the maximum number of x-axis labels
                        includeBounds: true,
                        crossAlign: 'far',
                        font: {
                          size: 14,
                          weight: 'bold'
                        },  
                      },
                      grid: {
                        tickColor: 'rgba(255, 255, 255, 1)'
                      },
                    },
                  },
                  animation: false,
                  
                  plugins: {
                    tooltip: {
                      backgroundColor: 'rgba(255, 255, 255, 1)',
                      titleColor: 'rgba(0, 0, 0, 1)',
                      bodyColor: 'rgba(0, 0, 0, 1)',
                      padding: 12,
                      cornerRadius: 12,
                      caretPadding: 12,
                      caretSize: 8,
                      bodyAlign: 'right'
                    },
                    legend: {
                      responsive: true,
                      display: true,
                      position: 'bottom', // or 'bottom', 'left', 'right'
                      align: 'center', // or 'start', 'end'
                      labels: {
                        font: {
                          size: 12,
                          weight: 'bold',
                        },
                        boxHeight: 2, // Adjust the width of the colored boxes in the legend
                        boxWidth: 20,
                        padding: 15, // Adjust the padding between legend elements
                      },
                    },
                  },
                  
                }
              });
              
              colours = ['rgba(100, 220, 150, 1)', 'rgba(255, 165, 0, 1)', 'rgba(0, 123, 255, 1)', 'rgba(76, 169, 255, 143)', 'rgba(56, 122, 122, 1)', 'rgba(122, 32, 190, 1)']
              
              // Populate asset mix chart
              var count = 0;
              for (var key in price_data) {
                if (price_data.hasOwnProperty(key) && key !== "date") {
                  myLineChart.data.datasets.push({
                    label: key,
                    data: price_data[key],
                    fill: false,
                    borderColor: colours[count%colours.length],
                    borderWidth: 2.5,
                    pointRadius: 10,
                    pointBorderColor: 'rgba(100, 220, 150, 0)',
                    pointBackgroundColor: 'rgba(100, 220, 150, 0)',
                    pointHoverRadius: 10,
                    pointHoverBackgroundColor: colours[count%colours.length],
                    pointHoverBorderColor: 'rgba(255, 255, 255, 1)',
                    pointHoverBorderWidth: 3,
                  });
                  count++;
                }
              } 
              myLineChart.update();
              
              // create charts for each asset
              var assets = {{ portfolio.asset_data|safe }}
              var collapseBuy = {}
              var collapseSell = {}
              
              for (var asset of assets) {
                console.log("asset:", asset.ticker);
                
                console.log("asset.index:", asset.index);
                if (asset.ticker !== "Cash Balance") {
                  
                  // create chooti chart
                  var ctxAssetChart = document.getElementById("asset_chart_" + asset.index).getContext('2d');
                  ctxAssetChart.canvas.width = '200px';
                  ctxAssetChart.canvas.height = '50px';
                  
                  if (asset.current_price_change_status === "NEGATIVE") {
                    price_chart_border_color = RED_BORDER;
                    price_chart_background_color = RED_BACKGROUND;
                  } else {
                    price_chart_border_color = GREEN_BORDER;
                    price_chart_background_color = GREEN_BACKGROUND;
                  }
                  
                  var price_chart_date = JSON.parse(asset.price_chart).date
                  var price_chart_price = JSON.parse(asset.price_chart).price
                  
                  var assetChart = new Chart(ctxAssetChart, {
                    type: 'line',
                    data: {
                      labels: price_chart_date,
                      datasets: [{
                        data: price_chart_price,
                        fill: true,
                        backgroundColor: price_chart_background_color,
                        borderColor: price_chart_border_color,
                        borderWidth: 2.5,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                      }]              },
                      options: {
                        scales: {
                          x: {
                            display: false,
                            type: 'time',
                            time: {
                              unit: 'day',
                              tooltipFormat: 'DD'
                            },
                            grid: {
                              display: false, // Turn off x-axis grid lines
                            },
                            
                            ticks: {
                              display: false
                            },
                            scaleLineColor: 'rgba(0, 0, 0, 0)'
                            
                          },
                          y: {
                            display: false,
                            beginAtZero: false,
                            position: 'right',
                            grid: {
                              display: false, // Turn off x-axis grid lines
                            },
                            
                            ticks: {
                              display: false
                            },
                            scaleLineColor: 'rgba(0, 0, 0, 0)'
                          }
                        },
                        plugins: {
                          tooltip: {
                            enabled: false,
                            displayColors: false,
                            backgroundColor: 'rgba(255, 255, 255, 1)',
                            titleColor: 'rgba(0, 0, 0, 1)',
                            bodyColor: 'rgba(0, 0, 0, 1)',
                            padding: 12,
                            cornerRadius: 12,
                            caretPadding: 12,
                            caretSize: 8 ,
                            bodyAlign: 'right'                       
                          },
                          hover: {mode: null},
                          legend: {
                            display: false
                          },
                          chartAreaBorder: {
                            borderColor: 'red',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            borderDashOffset: 2,
                          }
                        }
                      }
                    });
                    
                    
                    var ctxPriceChart = document.getElementById("price_chart_" + asset.index).getContext('2d');
                    ctxPriceChart.canvas.width = '898px';
                    ctxPriceChart.canvas.height = '150px';
                    
                    var myLineChart = new Chart(ctxPriceChart, {
                      type: 'line',
                      data: {
                        labels: price_chart_date,
                        datasets: [{
                          data: price_chart_price,
                          fill: true,
                          backgroundColor: price_chart_background_color,
                          borderColor: price_chart_border_color,
                          borderWidth: 3,
                          pointRadius: 10,
                          pointBorderColor: 'rgba(100, 220, 150, 0)',
                          pointBackgroundColor: 'rgba(100, 220, 150, 0)',
                          pointHoverRadius: 10,
                          pointHoverBackgroundColor: price_chart_border_color,
                          pointHoverBorderColor: 'rgba(255, 255, 255, 1)',
                          pointHoverBorderWidth: 3,
                        }]
                      },
                      options: {
                        scales: {
                          x: {
                            type: 'time',
                            time: {
                              unit: 'day',
                              tooltipFormat: 'DD'
                            },
                            ticks: {
                              maxTicksLimit: 4, // Set the maximum number of x-axis labels
                              maxRotation: 0,   // Set the maximum label rotation angle
                              minRotation: 0,
                              align: 'start',
                              font: {
                                size: 14,
                                weight: 'bold'
                              },  
                            },
                            grid: {
                              tickColor: 'rgba(255, 255, 255, 1)'
                            },
                          },
                          y: {
                            beginAtZero: false,
                            position: 'right',
                            ticks: {
                              // You can add additional y-axis tick options here if needed
                              maxTicksLimit: 4, // Set the maximum number of x-axis labels
                              includeBounds: true,
                              crossAlign: 'far',
                              font: {
                                size: 14,
                                weight: 'bold'
                              },  
                            },
                            grid: {
                              tickColor: 'rgba(255, 255, 255, 1)'
                            },
                          }
                        },
                        animation: false,
                        tooltips: {
                          mode: 'index',
                          intersect: false
                        },
                        hover: {
                          mode: 'index',
                          intersect: false
                        },
                        plugins: {
                          legend: {
                            display: false,
                          },
                          tooltip: {
                            displayColors: false,
                            backgroundColor: 'rgba(255, 255, 255, 1)',
                            titleColor: 'rgba(0, 0, 0, 1)',
                            bodyColor: 'rgba(0, 0, 0, 1)',
                            padding: 12,
                            cornerRadius: 12,
                            caretPadding: 12,
                            caretSize: 8,
                            bodyAlign: 'right'                      },
                          }
                        }
                      });
                      
                      // create candlestick chart
                      console.log("making cnadlestick chart for", asset.index);
                      var myDiv = document.getElementById("asset_chart_two_" + asset.index).getContext('2d');
                      console.log("myDiv", myDiv);
                      
                      var chart = new Chart(myDiv, {
                        type: 'candlestick',
                        data: {
                          datasets: [{
                            label: asset.ticker,
                            data: [],
                            pointBackgroundColor: 'white',
                            pointBorderColor: 'white',
                            pointBorderWidth: 0,
                            // Custom colors for bullish and bearish candlesticks
                            backgroundColor: {
                              up: '#111111', // color for rising prices
                              down: RED_BACKGROUND  // color for falling prices
                            },
                          }]
                        },
                        options: {
                          scales: {
                            x: {
                              time: {
                                unit: 'day',
                                tooltipFormat: 'DD'
                              },
                              ticks: {
                                align: "start",
                                font: {
                                  size: 14,
                                  weight: 'bold'
                                },
                              },
                              grid: {
                                tickColor: 'rgba(255, 255, 255, 1)'
                              },
                            },
                            y: {
                              beginAtZero: false,
                              position: 'right',
                              ticks: {
                                font: {
                                  size: 14,
                                  weight: 'bold'
                                }
                              },
                              grid: {
                                tickColor: 'rgba(255, 255, 255, 1)'
                              },
                            }
                          },
                          plugins: {
                            legend: {
                              display: false
                            },
                            tooltip: {
                              displayColors: false,
                              backgroundColor: 'rgba(255, 255, 255, 1)',
                              titleColor: 'rgba(0, 0, 0, 1)',
                              bodyColor: 'rgba(0, 0, 0, 1)',
                              padding: 12,
                              cornerRadius: 12,
                              caretPadding: 12,
                              bodyAlign: 'right'
                            },
                          },
                          grid: {
                            color: 'rgba(0,0,0,0.1)',
                          },
                          // Add border to the entire chart
                          elements: {
                            line: {
                              tension: 0, // Disable bezier curves for line chart
                            },
                          },
                          borderColor: 'rgba(0, 0, 0, 1)', // Border color for the entire chart
                          borderWidth: 1, // Border width for the entire chart
                          animation: false, // Disable chart animation
                        }
                      });
                      
                      load_chart(asset.ticker, asset.index,'threeM', chart);
                      var index = String(asset.index)
                      var collapseBuyItem = new bootstrap.Collapse(document.getElementById("collapseBuy_" + index));
                      var collapseSellItem = new bootstrap.Collapse(document.getElementById("collapseSell_" + index));
                      //collapseBuyItem.hide()
                      //collapseSellItem.hide()
                      console.log("hiding", collapseBuyItem)
                      console.log("hiding", collapseSellItem)
                      
                      
                      collapseBuy[index] = collapseBuyItem
                      collapseSell[index] = collapseSellItem
                      
                      console.log("added", asset.index, "to", collapseBuy)
                      console.log("added", asset.index, "to", collapseSell)
                      
                      document.getElementById("buy-order-button_" + index).addEventListener('change', function (event) {
                        // Before showing the first collapse, ensure the second one is closed
                        var checkBox = event.target
                        //document.getElementById('collapseOrder_' + checkBox.dataset.index).style.display = "block";
                        //collapseBuy[checkBox.dataset.index].show();
                        
                        //checkBox.classList.add("collapsed")
                        console.log("running collapse listener to ", event.target, "supposed to trigger hide for", checkBox.dataset.index)
                        //event.target.checked = true
                        document.getElementById("sell-order-button_" + checkBox.dataset.index).checked = false
                        collapseSell[checkBox.dataset.index].hide();
                      });
                      
                      document.getElementById("sell-order-button_" + index).addEventListener('change', function (event) {
                        // Before showing the second collapse, ensure the first one is closed
                        //collapseSell[checkBox.dataset.index].show();
                        
                        var checkBox = event.target
                        //document.getElementById('collapseOrder_' + checkBox.dataset.index).style.display = "block";
                        //checkBox.classList.remove("collapsed")
                        console.log("running collapse listener to ", event.target, "supposed to trigger hide for", checkBox.dataset.index)
                        
                        //event.target.checked = true
                        
                        document.getElementById("buy-order-button_" + checkBox.dataset.index).checked = false
                        collapseBuy[checkBox.dataset.index].hide();
                        
                      });
                      
                      
                      
                      document.getElementById("buy-num-units_" + asset.index).addEventListener("keyup", function(event) {
                        // Check if the "Enter" key (key code 13) was pressed
                        var content = "USD 0.00"
                        
                        try {
                          var index = event.target.dataset.index
                          var price = parseFloat(event.target.dataset.price)
                          var str = event.target.value
                          console.log("str is", str)
                          
                          if (hasTwoOrFewerDecimalPoints(str)) {
                            var units = parseFloat(str)
                            console.log("units is", units)
                            console.log("current_price is", price)
                            
                            var currentPriceUsdDiv = document.getElementById('buy-current-price-usd_' + index);
                            
                            console.log("currentPriceUsdDiv", currentPriceUsdDiv)
                            if (currentPriceUsdDiv) {
                              console.log(currentPriceUsdDiv.dataset.value)
                              const currentPriceUsd = parseFloat(currentPriceUsdDiv.dataset.value)
                              console.log("read price usd as", currentPriceUsd)
                              var total = units * currentPriceUsd
                            } else {
                              var total = units * price
                            }

                            total = total.toFixed(2)
                            console.log("total is", total)
                            console.log("buy-order-value_" + index)
                            
                            content = "USD " + total
                            if (total > parseFloat("{{ portfolio.cash_balance }}")) {
                              triggerBuyNotAdequateCashMessage(index)
                            }  else if (units > 0) {
                              triggerBuyValidMessage(index)
                            } else {
                              deleteBuyMessages(index)
                            }
                          } else {
                            if (str !== "") {
                              triggerBuyMultiplesMessage(index)
                              console.log("has to be multiples of 0.01")
                            } else {
                              deleteBuyMessages(index)
                            }
                          }
                        } catch (error) {
                          // Handle the error here if needed
                          console.error("An error occurred:", error);
                        }
                        document.getElementById("buy-order-value_" + index).innerHTML = content
                      });
                      
                      document.getElementById("sell-num-units_" + asset.index).addEventListener("keyup", function(event) {
                        // Check if the "Enter" key (key code 13) was pressed
                        var content = "USD 0.00"
                        
                        try {
                          var index = event.target.dataset.index
                          var price = parseFloat(event.target.dataset.price)
                          var current_units = parseFloat(event.target.dataset.current_units)
                          var str = event.target.value
                          console.log("str is", str)
                          console.log("current_units is", current_units)
                          
                          
                          if (hasTwoOrFewerDecimalPoints(str)) {
                            var units = parseFloat(str)
                            console.log("units is", units)
                            console.log("current_price is", price)

                            var currentPriceUsdDiv = document.getElementById('sell-current-price-usd_' + index);
                            
                            console.log("currentPriceUsdDiv", currentPriceUsdDiv)
                            if (currentPriceUsdDiv) {
                              console.log(currentPriceUsdDiv.dataset.value)
                              const currentPriceUsd = parseFloat(currentPriceUsdDiv.dataset.value)
                              console.log("read price usd as", currentPriceUsd)
                              var total = units * currentPriceUsd
                            } else {
                              var total = units * price
                            }

                            total = total.toFixed(2)
                            console.log("total is", total)
                            console.log("sell-order-value_" + index)
                            
                            content = "USD " + total
                            if (units > current_units) {
                              triggerSellNotAdequateUnitsMessage(index)
                            } else if (units > 0) {
                              triggerSellValidMessage(index)
                            } else {
                              deleteSellMessages(index)
                            }
                          } else {
                            if (str !== "") {
                              triggerSellMultiplesMessage(index)
                            } else {
                              deleteSellMessages(index)
                            }
                          }
                        } catch (error) {
                          // Handle the error here if needed
                          console.error("An error occurred:", error);
                        }
                        document.getElementById("sell-order-value_" + index).innerHTML = content
                      });
                      
                      
                      
                      
                      
                      
                      
                      //document.querySelectorAll('.btn-check').forEach(function (checkbox) {
                        //  checkbox.addEventListener('change', function (event) {
                          //    var checkBox = event.target;
                          //
                          //    if (checkBox.checked) {
                            //      // If a checkbox is checked, hide the other collapse
                            //      if (checkBox.id.includes('buy-order-button')) {
                              //        collapseSell['collapseSell_' + checkBox.dataset.index].hide();
                              //      } else if (checkBox.id.includes('sell-order-button')) {
                                //        collapseBuy['collapseBuy_' + checkBox.dataset.index].hide();
                                //      }
                                //    }
                                //  });
                                //});
                                
                                
                                //document.getElementById("buy-order-button_" + index).click()
                                //document.getElementById("sell-order-button_" + index).click()
                                
                                //collapseBuy[index].hide()
                                //collapseSell[index].hide()
                              }
                            }
                            
                            // create chooti chart for search asset
                            var ctxSearchAssetChart = document.getElementById("search_asset_small_chart").getContext('2d');
                            ctxSearchAssetChart.canvas.width = '200px';
                            ctxSearchAssetChart.canvas.height = '50px';
                            
                            
                            var searchAssetChart = new Chart(ctxSearchAssetChart, {
                              type: 'line',
                              data: {
                                labels: price_chart_date,
                                datasets: []              },
                                options: {
                                  scales: {
                                    x: {
                                      display: false,
                                      type: 'time',
                                      time: {
                                        unit: 'day',
                                        tooltipFormat: 'DD'
                                      },
                                      grid: {
                                        display: false, // Turn off x-axis grid lines
                                      },
                                      
                                      ticks: {
                                        display: false
                                      },
                                      scaleLineColor: 'rgba(0, 0, 0, 0)'
                                      
                                    },
                                    y: {
                                      display: false,
                                      beginAtZero: false,
                                      position: 'right',
                                      grid: {
                                        display: false, // Turn off x-axis grid lines
                                      },
                                      
                                      ticks: {
                                        display: false
                                      },
                                      scaleLineColor: 'rgba(0, 0, 0, 0)'
                                    }
                                  },
                                  plugins: {
                                    tooltip: {
                                      enabled: false,
                                      displayColors: false,
                                      backgroundColor: 'rgba(255, 255, 255, 1)',
                                      titleColor: 'rgba(0, 0, 0, 1)',
                                      bodyColor: 'rgba(0, 0, 0, 1)',
                                      padding: 12,
                                      cornerRadius: 12,
                                      caretPadding: 12,
                                      caretSize: 8 ,
                                      bodyAlign: 'right'                       
                                    },
                                    hover: {mode: null},
                                    legend: {
                                      display: false
                                    },
                                    chartAreaBorder: {
                                      borderColor: 'red',
                                      borderWidth: 2,
                                      borderDash: [5, 5],
                                      borderDashOffset: 2,
                                    }
                                  }
                                }
                              });
                              
                              var ctxSearchAssetPriceChart = document.getElementById("search_asset_price_chart").getContext('2d');
                              ctxSearchAssetPriceChart.canvas.width = '898px';
                              ctxSearchAssetPriceChart.canvas.height = '150px';
                              
                              var searchAssetPriceChart = new Chart(ctxSearchAssetPriceChart, {
                                type: 'line',
                                data: {
                                  datasets: []
                                },
                                options: {
                                  scales: {
                                    x: {
                                      type: 'time',
                                      time: {
                                        unit: 'day',
                                        tooltipFormat: 'DD'
                                      },
                                      ticks: {
                                        maxTicksLimit: 4, // Set the maximum number of x-axis labels
                                        maxRotation: 0,   // Set the maximum label rotation angle
                                        minRotation: 0,
                                        align: 'start',
                                        font: {
                                          size: 14,
                                          weight: 'bold'
                                        },  
                                      },
                                      grid: {
                                        tickColor: 'rgba(255, 255, 255, 1)'
                                      },
                                    },
                                    y: {
                                      beginAtZero: false,
                                      position: 'right',
                                      ticks: {
                                        // You can add additional y-axis tick options here if needed
                                        maxTicksLimit: 4, // Set the maximum number of x-axis labels
                                        includeBounds: true,
                                        crossAlign: 'far',
                                        font: {
                                          size: 14,
                                          weight: 'bold'
                                        },  
                                      },
                                      grid: {
                                        tickColor: 'rgba(255, 255, 255, 1)'
                                      },
                                    }
                                  },
                                  animation: false,
                                  tooltips: {
                                    mode: 'index',
                                    intersect: false
                                  },
                                  hover: {
                                    mode: 'index',
                                    intersect: false
                                  },
                                  plugins: {
                                    legend: {
                                      display: false,
                                    },
                                    tooltip: {
                                      displayColors: false,
                                      backgroundColor: 'rgba(255, 255, 255, 1)',
                                      titleColor: 'rgba(0, 0, 0, 1)',
                                      bodyColor: 'rgba(0, 0, 0, 1)',
                                      padding: 12,
                                      cornerRadius: 12,
                                      caretPadding: 12,
                                      caretSize: 8,
                                      bodyAlign: 'right'                      },
                                    }
                                  }
                                });
                                
                                // create candlestick chart
                                console.log("making cnadlestick chart for search asset");
                                var myDiv = document.getElementById("asset_chart_two_" + "search_asset").getContext('2d');
                                console.log("myDiv", myDiv);
                                
                                var candlestickSearchAssetChart = new Chart(myDiv, {
                                  type: 'candlestick',
                                  data: {
                                    datasets: [{
                                      label: asset.ticker,
                                      data: [],
                                      pointBackgroundColor: 'white',
                                      pointBorderColor: 'white',
                                      pointBorderWidth: 0,
                                      // Custom colors for bullish and bearish candlesticks
                                      backgroundColor: {
                                        up: '#111111', // color for rising prices
                                        down: RED_BACKGROUND  // color for falling prices
                                      },
                                    }]
                                  },
                                  options: {
                                    scales: {
                                      x: {
                                        time: {
                                          unit: 'day',
                                          tooltipFormat: 'DD'
                                        },
                                        ticks: {
                                          align: "start",
                                          font: {
                                            size: 14,
                                            weight: 'bold'
                                          },
                                        },
                                        grid: {
                                          tickColor: 'rgba(255, 255, 255, 1)'
                                        },
                                      },
                                      y: {
                                        beginAtZero: false,
                                        position: 'right',
                                        ticks: {
                                          font: {
                                            size: 14,
                                            weight: 'bold'
                                          }
                                        },
                                        grid: {
                                          tickColor: 'rgba(255, 255, 255, 1)'
                                        },
                                      }
                                    },
                                    plugins: {
                                      legend: {
                                        display: false
                                      },
                                      tooltip: {
                                        displayColors: false,
                                        backgroundColor: 'rgba(255, 255, 255, 1)',
                                        titleColor: 'rgba(0, 0, 0, 1)',
                                        bodyColor: 'rgba(0, 0, 0, 1)',
                                        padding: 12,
                                        cornerRadius: 12,
                                        caretPadding: 12,
                                        bodyAlign: 'right'
                                      },
                                    },
                                    grid: {
                                      color: 'rgba(0,0,0,0.1)',
                                    },
                                    // Add border to the entire chart
                                    elements: {
                                      line: {
                                        tension: 0, // Disable bezier curves for line chart
                                      },
                                    },
                                    borderColor: 'rgba(0, 0, 0, 1)', // Border color for the entire chart
                                    borderWidth: 1, // Border width for the entire chart
                                    animation: false, // Disable chart animation
                                  }
                                });
                                
                                
                                
                                function load_chart(ticker, index, width, chart) {
                                  var myDiv = document.getElementById("asset_chart_two_" + index);
                                  myDiv.style.display = 'none';
                                  var myDiv = document.getElementById('asset_chart_spinner_' + index);
                                  myDiv.classList.remove('d-none');
                                  
                                  console.log("running load_chart on", ticker, width);
                                  fetch('{{ portfolio.id }}' + '/asset_data', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                      ticker: ticker,
                                      width: width
                                    })
                                  })
                                  .then(response => response.json())
                                  .then(result => {
                                    // Print result
                                    var myDiv = document.getElementById("asset_chart_two_" + index);
                                    myDiv.style.display = '';
                                    var myDiv = document.getElementById('asset_chart_spinner_' + index);
                                    myDiv.classList.add('d-none');
                                    
                                    console.log(result);
                                    var chartData = result.chart_data;
                                    chart.data.datasets[0].data = chartData;
                                    chart.update();
                                    
                                    
                                  })
                                }
                                
                                
                                
                                function search_asset() {
                                  ticker = document.getElementById("search_ticker").value;
                                  if (ticker.trim() === "") {
                                    return
                                  }
                                  console.log("search_ticker:", ticker)
                                  
                                  var myDiv = document.getElementById("search_asset_data");
                                  myDiv.style.display = 'none';
                                  var myDiv = document.getElementById('search_asset_spinner');
                                  myDiv.classList.remove('d-none');
                                  
                                  fetch('{{ portfolio.id }}' + '/search_asset', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                      ticker: ticker
                                    })
                                  })
                                  .then(response => response.json())
                                  .then(result => {
                                    console.log(result)
                                    
                                    // Update info
                                    
                                    document.getElementById("search_asset_ticker").innerHTML = result.ticker;
                                    document.getElementById("search_asset_long_name").innerHTML = result.long_name;
                                    document.getElementById("search_asset_price").innerHTML = result.current_price;
                                    change_button = document.getElementById("search_asset_price_change")
                                    change_button.innerHTML =  result.current_price_change;
                                    
                                    change_button.classList.remove(...change_button.classList);
                                    change_button.classList.add("badge")
                                    if (result.current_price_change_status === "POSITIVE") {
                                      change_button.classList.add("text-bg-success")
                                      
                                    } else if (result.current_price_change_status === "ZERO") {
                                      change_button.classList.add("text-bg-light")
                                      
                                    } else if (result.current_price_change_status === "NEGATIVE") {
                                      change_button.classList.add("text-bg-danger")
                                      
                                    }
                                    
                                    /*
                                    result.country
                                    result.quote_type
                                    result.currency
                                    result.exchange
                                    result.long_business_summary
                                    result.current_price_change_status
                                    result.dollar_price
                                    */
                                    
                                    document.getElementById("search_asset_currency").innerHTML = result.currency;
                                    document.getElementById("search_asset_country").innerHTML = result.country;
                                    document.getElementById("search_asset_quote_type").innerHTML = result.quote_type;
                                    document.getElementById("search_asset_exchange").innerHTML = result.exchange;
                                    document.getElementById("search_asset_summary").innerHTML = result.long_business_summary;
                                    
                                    
                                    
                                    if (result.current_price_change_status === "NEGATIVE") {
                                      price_chart_border_color = RED_BORDER;
                                      price_chart_background_color = RED_BACKGROUND;
                                    } else {
                                      price_chart_border_color = GREEN_BORDER;
                                      price_chart_background_color = GREEN_BACKGROUND;
                                    }
                                    
                                    var price_chart_date = JSON.parse(result.price_chart).date;
                                    var price_chart_price = JSON.parse(result.price_chart).price;
                                    
                                    console.log(price_chart_date, price_chart_price);
                                    
                                    var chartData = result.chart_data;
                                    searchAssetChart.data.labels = price_chart_date;
                                    searchAssetChart.data.datasets[0] = {
                                      data: price_chart_price,
                                      fill: true,
                                      backgroundColor: price_chart_background_color,
                                      borderColor: price_chart_border_color,
                                      borderWidth: 2.5,
                                      pointRadius: 0,
                                      pointHoverRadius: 0,
                                    }
                                    
                                    searchAssetChart.update();
                                    
                                    searchAssetPriceChart.data.labels = price_chart_date;
                                    searchAssetPriceChart.data.datasets[0] = {
                                      data: price_chart_price,
                                      fill: true,
                                      backgroundColor: price_chart_background_color,
                                      borderColor: price_chart_border_color,
                                      borderWidth: 3,
                                      pointRadius: 10,
                                      pointBorderColor: 'rgba(100, 220, 150, 0)',
                                      pointBackgroundColor: 'rgba(100, 220, 150, 0)',
                                      pointHoverRadius: 10,
                                      pointHoverBackgroundColor: price_chart_border_color,
                                      pointHoverBorderColor: 'rgba(255, 255, 255, 1)',
                                      pointHoverBorderWidth: 3,
                                    }
                                    
                                    searchAssetPriceChart.update();
                                    load_chart(result.ticker, "search_asset",'threeM', candlestickSearchAssetChart);
                                    var myDiv = document.getElementById('search_asset_spinner');
                                    myDiv.classList.add('d-none');
                                    var myDiv = document.getElementById("search_asset_data");
                                    myDiv.style.display = '';
                                    document.getElementById("buy-num-units_search_asset").value = ""

                                    document.getElementById("buy-order-value_search_asset").innerHTML = "USD 0.00"
                                    document.getElementById("buy_search_asset_display").innerHTML = result.ticker
                                    document.getElementById("buy_search_asset_input").value = result.ticker
                                    document.getElementById("buy_search_asset_price").innerHTML = result.currency + " " + result.current_price
                                    deleteBuyMessages("search_asset")

                                    if (result.currency !== "USD") {
                                      document.getElementById("buy-rate-container_search_asset").style.display = 'flex'
                                      document.getElementById("buy-current-price-usd_search_asset").innerHTML = 'USD ' + result.current_price_usd.toFixed(2);
                                      document.getElementById("buy-num-units_search_asset").dataset.price = String(result.current_price_usd)

                                    } else {
                                      document.getElementById("buy-rate-container_search_asset").style.display = 'none'
                                      document.getElementById("buy-current-price-usd_search_asset").innerHTML = ''
                                      document.getElementById("buy-num-units_search_asset").dataset.price = String(result.current_price)
                                    }

                                  })
                                }
                                
                                var searchButton = document.getElementById("search_trigger");
                                
                                // Add an event listener to the button and attach the search_asset function
                                searchButton.addEventListener("click", search_asset);
                                
                                var searchInput = document.getElementById("search_ticker");
                                // Add an event listener for the "keyup" event
                                searchInput.addEventListener("keyup", function(event) {
                                  // Check if the "Enter" key (key code 13) was pressed
                                  if (event.key === "Enter") {
                                    // Call the search_asset function when "Enter" is pressed
                                    search_asset();
                                  }
                                });
                                
                                
                                
                                // Assuming you are using Bootstrap's data-bs-target attribute to identify the accordion element
                                document.getElementById('showAllButton').addEventListener('click', function() {
                                  console.log("showAllButton clicked...")
                                  var accordionButtons = document.querySelectorAll('.accordion-button.collapsed');
                                  console.log("collapsed buttons", accordionButtons)
                                  accordionButtons.forEach(button => button.click())
                                });
                                
                                document.getElementById('collapseAllButton').addEventListener('click', function() {
                                  console.log("collapseAllButton clicked...")
                                  
                                  var accordionButtons = document.querySelectorAll('.accordion-button:not(.collapsed)');
                                  console.log("non collapsed buttons", accordionButtons)
                                  
                                  accordionButtons.forEach(button => button.click())
                                });
                              });
                              
                              
                              function dropAssets() {
                                var elements = document.getElementsByClassName("accordion-collapse");
                                var elementsArray = Array.from(elements);
                                
                                // Remove class from each element
                                elementsArray.forEach(function(element) {
                                  element.classList.add("show");
                                  //element.aria-expanded="true";
                                });
                              }
                              
                              function collapseAssets() {
                                var elements = document.getElementsByClassName("accordion-collapse");
                                var elementsArray = Array.from(elements);
                                
                                // Remove class from each element
                                elementsArray.forEach(function(element) {
                                  element.classList.remove("show");
                                  //element.aria-expanded="false";
                                });
                              }
                              
                              function addMessage(content, type) {
                                const chatContainer = document.getElementById('chat-container');
                                const messageDiv = document.createElement('div');
                                messageDiv.className = 'message ' + type;
                                chatContainer.appendChild(messageDiv);
                                
                                // Split the content into words
                                const words = content.split(' ');
                                
                                words.forEach((word, index) => {
                                  setTimeout(() => {
                                    if (index !== 0) {
                                      messageDiv.innerHTML = messageDiv.textContent.slice(0, -2);
                                    }
                                    messageDiv.innerHTML += word;
                                    if (words[index+1] !== undefined) {
                                      messageDiv.innerHTML += ' ' + '  ●';
                                    }
                                  }, (index * 200) + 200*Math.random()); // Adjust the delay as needed (500 milliseconds in this example)
                                });
                              }
                              
                              function tickOneDay() {
                                // Change the location of the current page to the specified URL
                                window.location.href = "{% url 'tick_one_day' portfolio.id %}";
                              }
                              
                              
                              function openInNewTab(url) {
                                var win = window.open(url, '_blank');
                                win.focus();
                              }
                              
                              // Example usage:
                              addMessage("{{ portfolio.advice }}", "bot_message");
                              //document.getElementById("article_0").classList.add("active");
                              
                              
                              function hasTwoOrFewerDecimalPoints(str) {
                                // Regular expression to match integers or floats with two or fewer decimal points
                                const regex = /^\d+(\.\d{0,2})?$/;
                                
                                // Test if the string matches the regular expression
                                return regex.test(str);
                              }
                              
                              function triggerBuyNotAdequateCashMessage(index) {
                                document.getElementById('buy-num-units_'+ index + 'InvalidFeedback').innerHTML = "Not adequate cash."
                                document.getElementById('buy-num-units_'+ index).classList.remove("is-valid")
                                document.getElementById('buy-num-units_'+ index).classList.add("is-invalid")
                                document.getElementById('placeBuyOrder_'+ index).disabled = true;
                              }
                              
                              
                              function triggerBuyMultiplesMessage(index) {
                                document.getElementById('buy-num-units_'+ index + 'InvalidFeedback').innerHTML = "Enter multiple of 0.01"
                                document.getElementById('buy-num-units_'+ index).classList.remove("is-valid")
                                document.getElementById('buy-num-units_'+ index).classList.add("is-invalid")
                                document.getElementById('placeBuyOrder_'+ index).disabled = true;

                              }
                              
                              function triggerBuyValidMessage(index) {
                                document.getElementById('buy-num-units_'+ index).classList.remove("is-invalid")
                                document.getElementById('buy-num-units_'+ index).classList.add("is-valid")
                                document.getElementById('placeBuyOrder_'+ index).disabled = false;
                              }
                              
                              function deleteBuyMessages(index) {
                                document.getElementById('buy-num-units_'+ index).classList.remove("is-invalid")
                                document.getElementById('buy-num-units_'+ index).classList.remove("is-valid")
                                document.getElementById('placeBuyOrder_'+ index).disabled = false;
                              }
                              
                              function triggerSellNotAdequateUnitsMessage(index) {
                                document.getElementById('sell-num-units_'+ index + 'InvalidFeedback').innerHTML = "Not adequate units!"
                                document.getElementById('sell-num-units_'+ index).classList.remove("is-valid")
                                document.getElementById('sell-num-units_'+ index).classList.add("is-invalid")
                                document.getElementById('placeSellOrder_'+ index).disabled = true;
                              }
                              
                              function triggerSellMultiplesMessage(index) {
                                document.getElementById('sell-num-units_'+ index + 'InvalidFeedback').innerHTML = "Enter multiple of 0.01!"
                                document.getElementById('sell-num-units_'+ index).classList.remove("is-valid")
                                document.getElementById('sell-num-units_'+ index).classList.add("is-invalid")
                                document.getElementById('placeSellOrder_'+ index).disabled = true;
                              }
                              
                              function triggerSellValidMessage(index) {
                                document.getElementById('sell-num-units_'+ index).classList.remove("is-invalid")
                                document.getElementById('sell-num-units_'+ index).classList.add("is-valid")
                                document.getElementById('placeSellOrder_'+ index).disabled = false;
                              }
                              
                              function deleteSellMessages(index) {
                                document.getElementById('sell-num-units_'+ index).classList.remove("is-invalid")
                                document.getElementById('sell-num-units_'+ index).classList.remove("is-valid")
                                document.getElementById('placeSellOrder_'+ index).disabled = false;
                              }
                              
                              document.getElementById("buy-num-units_search_asset").addEventListener("keyup", function(event) {
                                // Check if the "Enter" key (key code 13) was pressed
                                var content = "USD 0.00"
                                
                                try {
                                  var index = "search_asset"
                                  var price = parseFloat(event.target.dataset.price)
                                  var str = event.target.value
                                  console.log("str is", str)
                                  
                                  if (hasTwoOrFewerDecimalPoints(str)) {
                                    var units = parseFloat(str)
                                    console.log("units is", units)
                                    console.log("current_price is", price)
                                    
                                    var total = units * price
                                    total = total.toFixed(2)
                                    console.log("total is", total)
                                    console.log("buy-order-value_" + index)
                                    
                                    content = "USD " + total
                                    if (total > parseFloat("{{ portfolio.cash_balance }}")) {
                                      triggerBuyNotAdequateCashMessage(index)
                                    }  else if (units > 0) {
                                      triggerBuyValidMessage(index)
                                    } else {
                                      deleteBuyMessages(index)
                                    }
                                  } else {
                                    if (str !== "") {
                                      triggerBuyMultiplesMessage(index)
                                      console.log("has to be multiples of 0.01")
                                    } else {
                                      deleteBuyMessages(index)
                                    }
                                  }
                                } catch (error) {
                                  // Handle the error here if needed
                                  console.error("An error occurred:", error);
                                }
                                document.getElementById("buy-order-value_search_asset").innerHTML = content

                              })
                              function closePortfolio() {
                                window.location.href = "{% url 'close_portfolio' portfolio.id %}";
                              }

                              function archivePortfolio() {
                                window.location.href = "{% url 'archive_portfolio' portfolio.id %}";
                              }

                              function unarchivePortfolio() {
                                window.location.href = "{% url 'unarchive_portfolio' portfolio.id %}";
                              }
                            </script>
                            {% endblock %}
                            